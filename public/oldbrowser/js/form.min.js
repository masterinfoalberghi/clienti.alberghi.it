	
	$(function() {
		
		var deleteOneTime = false;
		var firstKey = false;
		var firstScroll = 0;
		
		/*---------------------------------------------------------------------------------
		 * Post
		 *---------------------------------------------------------------------------------*/
		
		$(window).scroll(function() {
			if ($(this).scrollTop() > 180 && firstScroll == 0) {
				Tipped.hideAll();
				firstScroll = 1;
			}
		});

		$(window).click(function() {
			if (firstScroll == 0) {
				Tipped.hideAll();
				firstScroll = 1;
			}
		});

		$("#form_preventivo").submit( function (e) {
	alert("ok");
			$("#errors").html( "" ).hide();
			
			var error = false;
			var nome = $("#nome_input").val();
			var email = $("#email_input").val();
			var telefono = $("#phone_input").val();
			var prefisso = $("#prefix_input").val();
			var privacy = $(".privacy_accept");
			var html = "";

			removeErrors();
			
			$("#submit_button").hide();
			$(".loading-ajax").show()
			
			// $("#nome_input")
			// 	.parent()
			// 	.removeClass("error-form");

			if (_validateName(nome) < 10) {

				error = true;
				html += dizionario.email.nome_ko;
				$("#nome_input")
					.parent()
					.addClass("error-form");

			}

			if (_validateEmail(email) < 10) {
				
				error = true;
				html += dizionario.email.mail_ko;
				$("#email_input")
					.parent()
					.addClass("error-form");
					
			}

			if (_validateNumber(telefono) == 1) {
				
				error = true;
				html += dizionario.email.telefono_ko; 
				$("#phone_input")
					.parent()
					.addClass("error-form");
					
			}
				
			if (!_validatePrivacy(privacy)) {	
				
				error = true;
				html += dizionario.email.privacy_ko;
				
			}

			var numero_camere_js = $("#numero_camere").val();
		
			if (numero_camere_js > 0 ) {
				
				for (var i = 0; i < numero_camere_js; i++) {

					var $num_bambini_selected = $("#room_" + i +" .num_bambini").val();
					
					if ($num_bambini_selected > 0) {

						for (var c = 0; c < $num_bambini_selected; c++) {
							
							var $eta_bambino = $("#room_" + i + " .eta_select").eq(c).val();

							if ($eta_bambino == '-1') {
								
								error = true;
								$("#room_" + i +" .bambini_eta_" +c).removeClass("success-form").addClass("error-form");
								
							}
						}

					}		
				}
			}
			
			/**
			 * Prendo tutti i campi flexdate li cambio per essere funzionali
			 */
			
			$(".flex_date").hide();
			$(".flex_date").each(function () {
				
				if ($(this).is(":checked")) {
					$(this).val(1)
				} else {
					$(this).val(0).prop("checked", "checked")
				}
				
			});
			if (error) {
				
				e.preventDefault();
				$("#errors").html( dizionario.email.campi_compilati + html).show();
				$(".loading-ajax").hide();
				$(".flex_date").show();
				$("#submit_button").show();

			}
			
		});
		
		function removeErrors() {
		
			$("#attendi").html( "" ).hide();
			$("#errors").html( "" ).hide();
			$(".privacy_checkbox span, .privacy_checkbox span a").removeAttr("style");
			$(".privacy_checkbox").removeAttr("style");
			$(".privacy_checkbox i").removeAttr("style").hide();

		}

		/*---------------------------------------------------------------------------------
		 * Azioni
		 *---------------------------------------------------------------------------------*/
		
		/**
		 * Correttore inserimento nome e cognome
		 */
	
		$("#nome_input").keyup(function () {
			
			var name = $(this).val();
			var val = _validateName(name);
			
			if (val == 0) {
				
				$("#nome_input")
					.closest(".col-form")
						.removeClass("error-form")
						.removeClass("success-form");

				if (firstKey)
					removeErrors();
				
			} else if (val == 1) {
				
				$("#nome_input")
					.closest(".col-form")
						.addClass("error-form")
						.removeClass("success-form");
						
			} else {
				
				$("#nome_input")
					.closest(".col-form")
						.addClass("success-form")
						.removeClass("error-form");

				if (firstKey)
					removeErrors();
				
			}
				
		}).trigger("keyup");
		
		/**
		 * Correttore inserimento email
		 */
		 
		$("#email_input").keyup(function () {
			
			var me = $(this);
			var email = me.val();
			var val = _validateEmail(email);
			
			if (val == 0) {
				
				me
					.closest(".col-form")
						.removeClass("error-form")
						.removeClass("success-form");

				if (firstKey)
					removeErrors();
				
			} else if (val == 1) {
				
				me
					.closest(".col-form")
						.addClass("error-form")
						.removeClass("success-form");
				
			} else {
				
				me
					.closest(".col-form")
						.addClass("success-form")
						.removeClass("error-form");

				if (firstKey)
					removeErrors();
				
			}
				
		}).trigger("keyup");
		
		/**
		 * Correttore inserimento numero di telefono
		 */
		
		$("#phone_input").keyup(function () {
			
			var phone = $(this).val();
			var val = _validateNumber(phone);
			
			if (val == 0) {
				
				$("#phone_input")
					.closest(".col-form")
						.removeClass("error-form")
						.removeClass("success-form");

				if (firstKey)
					removeErrors();

				$("#whatsapp_check").prop("disabled", "disabled");
				$("#whatsapp_check").closest(".label_checkbox").css("opacity", 0.5);
				
			} else if (val == 1) {
				
				$("#phone_input")
					.closest(".col-form")
						.addClass("error-form")
						.removeClass("success-form");

				$("#whatsapp_check").prop("disabled", "disabled");
				$("#whatsapp_check").closest(".label_checkbox").css("opacity", 0.5);
				
			} else {
				
				$("#phone_input")
					.closest(".col-form")
						.addClass("success-form")
						.removeClass("error-form");

				if (firstKey)
					removeErrors();

				$("#whatsapp_check").prop("disabled", "");
				$("#whatsapp_check").closest(".label_checkbox").css("opacity", 1);
				
			}
				
		}).trigger("keyup");
		
		firstKey = true;

		/*---------------------------------------------------------------------------------
		 * Bottoni
		 *---------------------------------------------------------------------------------*/	
		 
		$("#addCamera").click(function (e) {
			
			Tipped.hideAll();
			e.preventDefault();
			var n = parseInt($("#numero_camere").val());
			if(n == 5) {
				window.alert('Hai raggiunto il numero massimo di camere');
				return;
			}

			$("#numero_camere").val(n+1);
			
			var $oldRoom = $("#rooms-list .room").last();
			var $newRoom = $oldRoom.clone();	
			var idOldRoom = $newRoom.attr("id");
			
			$newRoom.hide();
			$newRoom.attr("id", "room_" + n)
			
			$("#rooms-list").append($newRoom);
			$("#room_"+n+" .camera_label b").text("Camera" + (n+1));
						
			/**
			 * Riporto i valori
			 */
			
			// Arrivo e partenza

			$newRoom
				.find(".daterange_select")
				.attr("data-id", n);

			$newRoom
				.find(".dateinfo")
				.attr("id", "dateinfo_" + n);

			$newRoom
				.find(".daterange")
				.removeClass("init")
				.attr("id", "data_picker_" + n)
				.attr("data-id", n);

			$newRoom
				.find(".arrivo_datepicker")
				.empty();

			$newRoom
				.find(".partenza_datepicker")
				.empty();

			$newRoom
				.find(".arrivo")
				.attr("id", "arrivo_" + n);

			$newRoom
				.find(".partenza")
				.attr("id", "partenza_" + n);

			$newRoom
				.find(".arrivo_datepicker")
				.attr("id", "arrivo_datepicker_" + n);

			$newRoom
				.find(".partenza_datepicker")
				.attr("id", "partenza_datepicker_" + n);

			$newRoom
				.find(".arrivo_button")
				.attr("id", "arrivo_button_" + n);

			$newRoom
				.find(".partenza_button")
				.attr("id", "partenza_button_" + n);

			// Adulti e bambini
			$newRoom
				.find(".pannello_bambini")
				.attr("id", "pannello_bambini_" + n)
				.hide();
			
			$newRoom
				.find(".num_adulti")
				.val("2");

			$newRoom
				.find(".num_bambini")
				.attr("data-id", n)
				.removeClass("init")
				.val("0");
	
			$newRoom
				.find(".eta_select")
				.val("-1")
				.removeClass("init");

			$newRoom
				.find(".bambini_eta")
				.addClass("error-form")
				.removeClass("success-form");

			// Flex date
			$newRoom
				.find(".label_checkbox")
				.attr("for", "flex_date_" + n);

			$newRoom
				.find(".flex_date")
				.attr("id", "flex_date_" + n);

			// Tooltip
			$newRoom
				.find(".tooltip-small")
				.removeClass("init");
			
			$newRoom
				.find(".emailaddress")
				.remove();

			activeDatePicker();
			activeBambini();
			formTooltip();
			
			$newRoom.show("fast", function () {
				$(document.body).trigger("sticky_kit:recalc");
			});
			
			$("#delCamera").show("fast");
			$(".camera_label").show();

			if (n == 4) {
				$("#addCamera").hide("fast");
			} 
			else {
				$("#addCamera").show("fast");
			}
			
		});
		
		$("#delCamera").click(function (e) {
			
			Tipped.hideAll();
			
			if (!deleteOneTime) {
				deleteOneTime = true;
			
				e.preventDefault();
				var n = parseInt($("#numero_camere").val());
				
				if (n == 2)
					$(this).hide();
				
				$("#rooms-list .room")
					.last()
					.hide("fast" , 
						function () { 
							$(this).remove(); 
							$(document.body).trigger("sticky_kit:recalc"); 
							deleteOneTime = false;
						});
						
				$("#numero_camere").val( n - 1 );

				if (n < 6) {
					$("#addCamera").show("fast");
				} 
			
			}
			
		});
		
		
		/*---------------------------------------------------------------------------------
		 * Tool tip
		 *---------------------------------------------------------------------------------*/	

		function formTooltip () {

			$(".tooltip-small").not("init").each( function () {

				if ( $(this).hasClass("tooltip-small-left"))  {

					Tipped.create(this, $(this).data("title"), {position: "left", maxWidth: 200});	

				} else if ($(this).hasClass("tooltip-small-red")) {

					// data-tipped-options="title: 'Small', size: 'small', skin: 'red', close: true"
					// showOn:false, hideOn: false,
					Tipped.create(this, $(this).data("title"), {close: true, title:'<i style="font-size:16px; color:#fff;" class="icon-whatsapp"></i> WhatsApp&reg;', position: "left", maxWidth: 250, skin: "purple"}).show();	

				} else {

					Tipped.create(this, $(this).data("title"), {hook: "topleft", maxWidth: 200});	

				}

				$(this).addClass("init");

			});

		} 

		formTooltip();

		/*---------------------------------------------------------------------------------
		 * Data picker
		 *---------------------------------------------------------------------------------*/	
		
		$(document).click(function (e) {

		 	if(!$(e.target).closest('.daterange_select').length) {

			 	$(".arrivo_datepicker").hide();
			 	$(".partenza_datepicker").hide();
			 	$(".select_icon").removeClass("selected");

		 	}

		 }); 

	    function calcoloGiorni(start, end, id) {

	    	var dateFormat, dayFormat, infoHtml

	    	dayFormat = "D";
			dayNameFormat = "ddd";
			dateFormat = 'D MM YYYY';
			diff = end.diff(start, 'days');

			infoHtml = ""; 
			
			if (diff == 1){
				infoHtml +=  diff + ' ' + dizionario.email.notte[0];
			}
			else {
				infoHtml += diff + ' ' + dizionario.email.notte[1];
			}
 
	    	infoHtml += " (" + start.format(dayNameFormat) + " &rarr; " + end.format(dayNameFormat) + ")";
			

			if (!isNaN(diff)) {
				$("#dateinfo_" + id).html( infoHtml );
			}

	    }

		function activeDatePicker() {

		    $(".daterange").not(".init").each(function () {
				
			    var $me = $(this);
			    var id = $me.parent().data("id"); // order number
			    var flex = $me.parent().data("flex");// is flex date ?

			    // Date iniziali

			    var defaultViewStart = 	moment($("#arrivo_" + id).val(), "D/M/Y");
			    var defaultViewEnd = 	moment($("#partenza_" + id).val(), "D/M/Y");

			    // Cambio il valore dei campi button

				$("#arrivo_button_" + id)
			       	.html('<i class="icon-calendar"></i>&nbsp;' + defaultViewStart.format("D MMM Y") + '<i class="icon-down-open"></i>');

		        $("#partenza_button_" + id)
		       		.html('<i class="icon-calendar"></i>&nbsp;' + defaultViewEnd.format("D MMM Y") + '<i class="icon-down-open"></i>');

		       	// Attivo i Date picker

			    $("#arrivo_datepicker_" + id).datepicker({

			    	format: 'dd/mm/yyyy', 
			        weekStart:1,
			        startDate: moment().format("D/M/Y"),
			        language: "it",
			        todayHighlight: true,
					
			    }).on("changeDate", function(e) {
			        
			        var data_dal = moment($("#arrivo_datepicker_" + id).datepicker("getDate"));
			        var data_al = moment($("#partenza_datepicker_" + id).datepicker("getDate"));

			        $("#arrivo_button_" + id)
			        	.html('<i class="icon-calendar"></i>&nbsp;' + data_dal.format("D MMM Y")+ '<i class="icon-down-open"></i>');

			        $("#arrivo_" + id).val(data_dal.format("D/M/Y"));

			        if (data_al.isBefore(data_dal)) {

				          data_al = data_dal.add(1, 'd'); 

				          $("#partenza_" + id).val(data_al.format("D/M/Y"));

				          $("#partenza_datepicker_" + id)
				          	.datepicker("setDate", data_al.format("D/M/Y") );

				          $("#partenza_button_" + id)
				          	.html('<i class="icon-calendar"></i>&nbsp;' + data_al.format("D MMM Y")+ '<i class="icon-down-open"></i>');

			        }

			        $("#arrivo_datepicker_" + id)
			        	.datepicker("setRange", [ data_dal, data_al]);
			        	
			        $("#partenza_datepicker_" + id)
			        	.datepicker("setRange", [ data_dal, data_al])
			        	.datepicker("setStartDate", moment(e.date).add(1, 'd').format("D/M/Y") )

			        $(".arrivo_datepicker").hide();
			        $(".partenza_datepicker").hide();
			        $("#partenza_datepicker_" + id).show();

			        $(".select_icon").removeClass("selected");
			        $("#partenza_button_" + id).addClass("selected");

			        calcoloGiorni(data_dal, data_al, id);

			    });

			    $("#partenza_datepicker_" + id).datepicker({

					format: 'dd/mm/yyyy', 
			        weekStart:1,
			        startDate: moment().add(1,"d").format("D/M/Y"),
			        language: "it",
			        todayHighlight: true,

			    }).on("changeDate", function(e) {

			        var data_dal = moment($("#arrivo_datepicker_" + id).datepicker("getDate"));
			        if (isNaN(data_dal))
			        	data_dal = 	moment($("#arrivo_" + id).val(), "DD/MM/YYYY");

			        var data_al  = moment($("#partenza_datepicker_" + id).datepicker("getDate"));

			        $("#partenza_" + id).val(data_al.format("D/M/Y"));

			        $("#partenza_button_" + id).html('<i class="icon-calendar"></i>&nbsp;' + data_al.format("D MMM Y")+ '<i class="icon-down-open"></i>');

			        $("#arrivo_datepicker_" + id)
			        	.datepicker("setRange", [ data_dal, data_al]);

			        $("#partenza_datepicker_" + id)
			        	.datepicker("setRange", [ data_dal, data_al]);

			      	$(".arrivo_datepicker").hide();
			        $(".partenza_datepicker").hide();
			        $(".select_icon").removeClass("selected");

			        calcoloGiorni(data_dal, data_al, id);
		        	
				}); 

			    // Assegno i valori di defualt;

			    $("#arrivo_datepicker_" + id)
			        .datepicker("setRange", [ defaultViewStart, defaultViewEnd])
			        .datepicker("update", defaultViewStart.format("YYYY-MM-DD"));

			    $("#partenza_datepicker_" + id)
			        .datepicker("setRange", [ defaultViewStart, defaultViewEnd])
			        .datepicker("setStartDate", defaultViewEnd.format("D/M/Y"))
			        .datepicker("update", defaultViewEnd.format("YYYY-MM-DD"));

				calcoloGiorni(defaultViewStart, defaultViewEnd, id);

			    // Attivatori

				$("#arrivo_button_" + id).click(function (e) {

					e.preventDefault();
					$(".select_icon").removeClass("selected");
			      	$(".arrivo_datepicker").hide();
			        $(".partenza_datepicker").hide();
					$("#arrivo_datepicker_" + id).show();

					$(this).addClass("selected");
					$(document.body).trigger("sticky_kit:recalc");

				});

				$("#partenza_button_" + id).click(function (e) {

					e.preventDefault();
					$(".select_icon").removeClass("selected");
			      	$(".arrivo_datepicker").hide();
			        $(".partenza_datepicker").hide();
					$("#partenza_datepicker_" + id).show();

					$(this).addClass("selected");
					$(document.body).trigger("sticky_kit:recalc");

				});

				$me.addClass("init");
					
			});
				 
		}
		
		activeDatePicker();

		/*---------------------------------------------------------------------------------
		 * Bambini
		 *---------------------------------------------------------------------------------*/	
		
		function selectBambini ($nb) {
			
			var nb_val = parseInt($nb.find("option:selected").text());
			var $pn = $("#pannello_bambini_" + $nb.data("id"))
						
			for( var t = 0; t < 6; t++ ) {

				var $sl = $pn.find(".bambini_eta_" + t);
				
				if ( t < nb_val ) {
					
					$sl.show()
										
				} else {
					
					$sl.hide()
					$sl.find(">select").val("-1");
					
				} 
				
			}
			
			if (nb_val>0)
				$pn.fadeIn();
			else
				$pn.fadeOut();
			
		}
		
		function activeBambini() {
			
			$(".num_bambini").not(".init").each(function () {
				
				var $nb = $(this);
				$nb.change(function () {
					selectBambini ($nb);
				});
				selectBambini ($nb);
				$nb.addClass("init"); 
				
			});
			
			$(".eta_select").not(".init").each(function() {
				
				$es = $(this);
				$es.change(function () {
					
					var $this = $(this);
					
					$this
						.parent()
						.removeClass("success-form")
						.removeClass("error-form");
					
					if ($this.val() != "-1" )
						$this
							.parent()
							.addClass("success-form");
					
					
				});
				
				$es.addClass("init");
				$es.trigger("change");
				
			});
			
		}
		
		activeBambini();
				
						
	});